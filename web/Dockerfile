# ========================
# Stage 1: Deps
# ========================
FROM node:20-alpine AS deps
WORKDIR /app

# Optional: only needed if you use some native deps
# RUN apk add --no-cache libc6-compat

COPY package.json yarn.lock* package-lock.json* pnpm-lock.yaml* ./

RUN \
  if [ -f yarn.lock ]; then yarn install --frozen-lockfile; \
  elif [ -f package-lock.json ]; then npm ci; \
  elif [ -f pnpm-lock.yaml ]; then corepack enable && pnpm install --frozen-lockfile; \
  else echo "No lockfile found" && exit 1; \
  fi

# ========================
# Stage 1b: Dev Runner
# ========================
FROM node:20-alpine AS dev
WORKDIR /app
ENV NODE_ENV=development
ENV PORT=3000
ENV HOSTNAME=0.0.0.0

# Copy installed deps from deps stage
COPY --from=deps /app/node_modules ./node_modules
COPY . .

EXPOSE 3000

# Dev server MUST bind to 0.0.0.0 for other containers (Caddy) to reach it
# Yarn:
CMD ["yarn", "dev", "-H", "0.0.0.0", "-p", "3000"]
# If you use npm, replace with:
# CMD ["npm", "run", "dev", "--", "-H", "0.0.0.0", "-p", "3000"]
# If you use pnpm, replace with:
# CMD ["pnpm", "dev", "--", "-H", "0.0.0.0", "-p", "3000"]


# ========================
# Stage 2: Builder
# ========================
FROM node:20-alpine AS builder
WORKDIR /app
ENV NODE_ENV=production

COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Important: next.config.js must include `output: "standalone"`
RUN \
  if [ -f yarn.lock ]; then yarn build; \
  elif [ -f package-lock.json ]; then npm run build; \
  elif [ -f pnpm-lock.yaml ]; then corepack enable && pnpm build; \
  fi

# ========================
# Stage 3: Runner
# ========================
FROM node:20-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production
ENV PORT=3000
ENV HOSTNAME=0.0.0.0

# Security best practice
RUN addgroup -S nextjs && adduser -S nextjs -G nextjs

# Copy only what is needed to run the server
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/public ./public

USER nextjs
EXPOSE 3000

# `server.js` is generated by Next standalone build
CMD ["node", "server.js"]